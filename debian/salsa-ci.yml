include:
  - https://salsa.debian.org/salsa-ci-team/pipeline/raw/master/salsa-ci.yml
  - https://salsa.debian.org/salsa-ci-team/pipeline/raw/master/pipeline-jobs.yml

variables:
  SALSA_CI_DISABLE_APTLY: 0

.add-dependencies: &add-dependencies
  variables:
    SCI_LXC_PATH: ${CI_PROJECT_DIR}/lxc
    GPG_TRUSTED_DIR: ${SCI_LXC_PATH}/etc/apt/trusted.gpg.d
    MOIN_TEAM_URL: https://salsa.debian.org/moin-team
    APTLY_URL_SUFFIX: artifacts/raw/aptly
    PUBKEY_URL_SUFFIX: ${APTLY_URL_SUFFIX}/public-key.asc
    EMERALDTREE_JOBID: 4575438
    FEEDGEN_JOBID: 4575509
    FLASK_THEME_JOBID: 4575496
    FLATLAND_JOBID: 4576442
    PYXS_AUTOSIZE_JOBID: 4576472
    PYXS_BOOTSTRAP_JOBID: 4576577
    PYXS_CKEDITOR_JOBID: 4576527
    PYXS_JQFU_JOBID: 4576540
    PYXS_PYGMENTS_JOBID: 4576563
  script:
    - |
      cat >> ${SCI_LXC_PATH}/etc/apt/sources.list.d/new-packages-testing.list <<EOT
      deb ${MOIN_TEAM_URL}/emeraldtree/-/jobs/${EMERALDTREE_JOBID}/${APTLY_URL_SUFFIX} unstable main
      deb ${MOIN_TEAM_URL}/feedgen/-/jobs/${FEEDGEN_JOBID}/${APTLY_URL_SUFFIX} unstable main
      deb ${MOIN_TEAM_URL}/flask-theme/-/jobs/${FLASK_THEME_JOBID}/${APTLY_URL_SUFFIX} unstable main
      deb ${MOIN_TEAM_URL}/flatland/-/jobs/${FLATLAND_JOBID}/${APTLY_URL_SUFFIX} unstable main
      deb ${MOIN_TEAM_URL}/python-xstatic-autosize/-/jobs/${PYXS_AUTOSIZE_JOBID}/${APTLY_URL_SUFFIX} unstable main
      deb ${MOIN_TEAM_URL}/python-xstatic-bootstrap/-/jobs/${PYXS_BOOTSTRAP_JOBID}/${APTLY_URL_SUFFIX} unstable main
      deb ${MOIN_TEAM_URL}/python-xstatic-ckeditor/-/jobs/${PYXS_CKEDITOR_JOBID}/${APTLY_URL_SUFFIX} unstable main
      deb ${MOIN_TEAM_URL}/python-xstatic-jquery-file-upload/-/jobs/${PYXS_JQFU_JOBID}/${APTLY_URL_SUFFIX} unstable main
      deb ${MOIN_TEAM_URL}/python-xstatic-pygments/-/jobs/${PYXS_PYGMENTS_JOBID}/${APTLY_URL_SUFFIX} unstable main
      EOT
    - wget -q -O ${GPG_TRUSTED_DIR}/emeraldtree.asc ${MOIN_TEAM_URL}/emeraldtree/-/jobs/${EMERALDTREE_JOBID}/${PUBKEY_URL_SUFFIX}
    - wget -q -O ${GPG_TRUSTED_DIR}/feedgen.asc ${MOIN_TEAM_URL}/feedgen/-/jobs/${FEEDGEN_JOBID}/${PUBKEY_URL_SUFFIX}
    - wget -q -O ${GPG_TRUSTED_DIR}/flask-theme.asc ${MOIN_TEAM_URL}/flask-theme/-/jobs/${FLASK_THEME_JOBID}/${PUBKEY_URL_SUFFIX}
    - wget -q -O ${GPG_TRUSTED_DIR}/flatland.asc ${MOIN_TEAM_URL}/flatland/-/jobs/${FLATLAND_JOBID}/${PUBKEY_URL_SUFFIX}
    - wget -q -O ${GPG_TRUSTED_DIR}/python-xstatic-autosize.asc ${MOIN_TEAM_URL}/python-xstatic-autosize/-/jobs/${PYXS_AUTOSIZE_JOBID}/${PUBKEY_URL_SUFFIX}
    - wget -q -O ${GPG_TRUSTED_DIR}/python-xstatic-bootstrap.asc ${MOIN_TEAM_URL}/python-xstatic-bootstrap/-/jobs/${PYXS_BOOTSTRAP_JOBID}/${PUBKEY_URL_SUFFIX}
    - wget -q -O ${GPG_TRUSTED_DIR}/python-xstatic-ckeditor.asc ${MOIN_TEAM_URL}/python-xstatic-ckeditor/-/jobs/${PYXS_CKEDITOR_JOBID}/${PUBKEY_URL_SUFFIX}
    - wget -q -O ${GPG_TRUSTED_DIR}/python-xstatic-jquery-file-upload.asc ${MOIN_TEAM_URL}/python-xstatic-jquery-file-upload/-/jobs/${PYXS_JQFU_JOBID}/${PUBKEY_URL_SUFFIX}
    - wget -q -O ${GPG_TRUSTED_DIR}/python-xstatic-pygments.asc ${MOIN_TEAM_URL}/python-xstatic-pygments/-/jobs/${PYXS_PYGMENTS_JOBID}/${PUBKEY_URL_SUFFIX}

# From salsa-ci.yml and modified using the above.

.test-autopkgtest-revised: &test-autopkgtest-revised
  stage: test
  image: $SALSA_CI_IMAGES_AUTOPKGTEST
  rules:
    - if: $SALSA_CI_ENABLE_AUTOPKGTEST =~ /^(1|yes|true)$/
    - if: $SALSA_CI_DISABLE_ALL_TESTS =~ /^(1|yes|true)$/
      when: never
    - if: $SALSA_CI_DISABLE_AUTOPKGTEST !~ /^(1|yes|true)$/
  script:
    - wget --progress=dot:giga ${SALSA_CI_AUTOPKGTEST_LXC}/-/jobs/artifacts/master/raw/artifacts/lxc.tar?job=${RELEASE} -O lxc.tar
    - mkdir ${SCI_LXC_PATH} && tar xf lxc.tar -C ${SCI_LXC_PATH}
    - sed -i "/lxc.rootfs.path/ s@dir:.*/lxc/@dir:${SCI_LXC_PATH}/@" ${SCI_LXC_PATH}/autopkgtest-${RELEASE}-amd64/config
    - |
      cat >/etc/lxc/lxc.conf <<EOT
      lxc.lxcpath=${SCI_LXC_PATH}
      EOT
    - add_extra_repository.sh -v -e "${SALSA_CI_EXTRA_REPOSITORY}" -k "${SALSA_CI_EXTRA_REPOSITORY_KEY}"
      -t "${SCI_LXC_PATH}/autopkgtest-${RELEASE}-amd64/rootfs/etc"
    - *add-dependencies
    - umount -R /sys/fs/cgroup && mount -a
    - /etc/init.d/lxc-net start
    - /etc/init.d/lxc start
    - chown -R debci. ${WORKING_DIR}
    - export debci_autopkgtest_args="${SALSA_CI_AUTOPKGTEST_ARGS}"
    # su's -P is required to have ownership over /dev/stderr, /dev/stdout and
    # /dev/stdin, and then fix #256
    - su -P debci -c "debci localtest $WORKING_DIR/*.changes --suite ${RELEASE} --logs-dir ${DEBCI_LOG_PATH}" || ( ret=$?; [ $ret -eq 8 ] || [ $ret -eq 2 ] )
    - rm -rf ${WORKING_DIR}/debci/binaries
  variables:
    GIT_STRATEGY: fetch
    SCI_LXC_PATH: ${CI_PROJECT_DIR}/lxc
    DEBCI_LOG_PATH: ${WORKING_DIR}/debci
  artifacts:
    when: always
    paths:
      - ${WORKING_DIR}/debci
  needs:
    - job: build
      artifacts: true

# Override pipeline-jobs.yml with new definition.

autopkgtest:
  extends: .test-autopkgtest-revised
