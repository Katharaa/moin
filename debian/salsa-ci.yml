include:
  - https://salsa.debian.org/salsa-ci-team/pipeline/raw/master/salsa-ci.yml
  - https://salsa.debian.org/salsa-ci-team/pipeline/raw/master/pipeline-jobs.yml

variables:
  SALSA_CI_DISABLE_APTLY: 0
  TEST_ROOT: ${CI_PROJECT_DIR}/lxc
  TEST_APT_PATH: ${TEST_ROOT}/autopkgtest-${RELEASE}-amd64/rootfs/etc/apt
  TEST_GPG_TRUSTED_DIR: ${TEST_APT_PATH}/trusted.gpg.d
  PIUPARTS_ROOT: /tmp/debian-chroot
  PIUPARTS_APT_PATH: ${PIUPARTS_ROOT}/etc-target/apt
  PIUPARTS_GPG_TRUSTED_DIR: ${PIUPARTS_APT_PATH}/trusted.gpg.d
  MOIN_TEAM_URL: https://salsa.debian.org/moin-team
  APTLY_URL_SUFFIX: artifacts/raw/aptly
  PUBKEY_URL_SUFFIX: ${APTLY_URL_SUFFIX}/public-key.asc
  EMERALDTREE_JOBID: 4575438
  FEEDGEN_JOBID: 4575509
  FLASK_THEME_JOBID: 4575496
  FLATLAND_JOBID: 4576442
  PYXS_AUTOSIZE_JOBID: 4576472
  PYXS_BOOTSTRAP_JOBID: 4576577
  PYXS_CKEDITOR_JOBID: 4576527
  PYXS_JQFU_JOBID: 4576540
  PYXS_PYGMENTS_JOBID: 4576563

.add-dependencies: &add-dependencies
  - |
    cat > new-packages-testing.list <<EOT
    deb ${MOIN_TEAM_URL}/emeraldtree/-/jobs/${EMERALDTREE_JOBID}/${APTLY_URL_SUFFIX} unstable main
    deb ${MOIN_TEAM_URL}/feedgen/-/jobs/${FEEDGEN_JOBID}/${APTLY_URL_SUFFIX} unstable main
    deb ${MOIN_TEAM_URL}/flask-theme/-/jobs/${FLASK_THEME_JOBID}/${APTLY_URL_SUFFIX} unstable main
    deb ${MOIN_TEAM_URL}/flatland/-/jobs/${FLATLAND_JOBID}/${APTLY_URL_SUFFIX} unstable main
    deb ${MOIN_TEAM_URL}/python-xstatic-autosize/-/jobs/${PYXS_AUTOSIZE_JOBID}/${APTLY_URL_SUFFIX} unstable main
    deb ${MOIN_TEAM_URL}/python-xstatic-bootstrap/-/jobs/${PYXS_BOOTSTRAP_JOBID}/${APTLY_URL_SUFFIX} unstable main
    deb ${MOIN_TEAM_URL}/python-xstatic-ckeditor/-/jobs/${PYXS_CKEDITOR_JOBID}/${APTLY_URL_SUFFIX} unstable main
    deb ${MOIN_TEAM_URL}/python-xstatic-jquery-file-upload/-/jobs/${PYXS_JQFU_JOBID}/${APTLY_URL_SUFFIX} unstable main
    deb ${MOIN_TEAM_URL}/python-xstatic-pygments/-/jobs/${PYXS_PYGMENTS_JOBID}/${APTLY_URL_SUFFIX} unstable main
    EOT
  - wget -q -O emeraldtree.asc ${MOIN_TEAM_URL}/emeraldtree/-/jobs/${EMERALDTREE_JOBID}/${PUBKEY_URL_SUFFIX}
  - wget -q -O feedgen.asc ${MOIN_TEAM_URL}/feedgen/-/jobs/${FEEDGEN_JOBID}/${PUBKEY_URL_SUFFIX}
  - wget -q -O flask-theme.asc ${MOIN_TEAM_URL}/flask-theme/-/jobs/${FLASK_THEME_JOBID}/${PUBKEY_URL_SUFFIX}
  - wget -q -O flatland.asc ${MOIN_TEAM_URL}/flatland/-/jobs/${FLATLAND_JOBID}/${PUBKEY_URL_SUFFIX}
  - wget -q -O python-xstatic-autosize.asc ${MOIN_TEAM_URL}/python-xstatic-autosize/-/jobs/${PYXS_AUTOSIZE_JOBID}/${PUBKEY_URL_SUFFIX}
  - wget -q -O python-xstatic-bootstrap.asc ${MOIN_TEAM_URL}/python-xstatic-bootstrap/-/jobs/${PYXS_BOOTSTRAP_JOBID}/${PUBKEY_URL_SUFFIX}
  - wget -q -O python-xstatic-ckeditor.asc ${MOIN_TEAM_URL}/python-xstatic-ckeditor/-/jobs/${PYXS_CKEDITOR_JOBID}/${PUBKEY_URL_SUFFIX}
  - wget -q -O python-xstatic-jquery-file-upload.asc ${MOIN_TEAM_URL}/python-xstatic-jquery-file-upload/-/jobs/${PYXS_JQFU_JOBID}/${PUBKEY_URL_SUFFIX}
  - wget -q -O python-xstatic-pygments.asc ${MOIN_TEAM_URL}/python-xstatic-pygments/-/jobs/${PYXS_PYGMENTS_JOBID}/${PUBKEY_URL_SUFFIX}

# Modify salsa-ci.yml definitions using the above. Ideally, the original
# definitions would permit such customisation with only minimal augmentation.

.test-autopkgtest-revised: &test-autopkgtest-revised
  stage: test
  image: $SALSA_CI_IMAGES_AUTOPKGTEST
  rules:
    - if: $SALSA_CI_ENABLE_AUTOPKGTEST =~ /^(1|yes|true)$/
    - if: $SALSA_CI_DISABLE_ALL_TESTS =~ /^(1|yes|true)$/
      when: never
    - if: $SALSA_CI_DISABLE_AUTOPKGTEST !~ /^(1|yes|true)$/
  script:
    - wget --progress=dot:giga ${SALSA_CI_AUTOPKGTEST_LXC}/-/jobs/artifacts/master/raw/artifacts/lxc.tar?job=${RELEASE} -O lxc.tar
    - mkdir ${SCI_LXC_PATH} && tar xf lxc.tar -C ${SCI_LXC_PATH}
    - sed -i "/lxc.rootfs.path/ s@dir:.*/lxc/@dir:${SCI_LXC_PATH}/@" ${SCI_LXC_PATH}/autopkgtest-${RELEASE}-amd64/config
    - |
      cat >/etc/lxc/lxc.conf <<EOT
      lxc.lxcpath=${SCI_LXC_PATH}
      EOT
    - add_extra_repository.sh -v -e "${SALSA_CI_EXTRA_REPOSITORY}" -k "${SALSA_CI_EXTRA_REPOSITORY_KEY}"
      -t "${SCI_LXC_PATH}/autopkgtest-${RELEASE}-amd64/rootfs/etc"
    - *add-dependencies
    - mv new-packages-testing.list ${TEST_APT_PATH}/sources.list.d/new-packages-testing.list
    - mv *.asc ${TEST_GPG_TRUSTED_DIR}
    - umount -R /sys/fs/cgroup && mount -a
    - /etc/init.d/lxc-net start
    - /etc/init.d/lxc start
    - chown -R debci. ${WORKING_DIR}
    - export debci_autopkgtest_args="${SALSA_CI_AUTOPKGTEST_ARGS}"
    # su's -P is required to have ownership over /dev/stderr, /dev/stdout and
    # /dev/stdin, and then fix #256
    - su -P debci -c "debci localtest $WORKING_DIR/*.changes --suite ${RELEASE} --logs-dir ${DEBCI_LOG_PATH}" || ( ret=$?; [ $ret -eq 8 ] || [ $ret -eq 2 ] )
    - rm -rf ${WORKING_DIR}/debci/binaries
  variables:
    GIT_STRATEGY: fetch
    SCI_LXC_PATH: ${CI_PROJECT_DIR}/lxc
    DEBCI_LOG_PATH: ${WORKING_DIR}/debci
  artifacts:
    when: always
    paths:
      - ${WORKING_DIR}/debci
  needs:
    - job: build
      artifacts: true

.test-piuparts-revised: &test-piuparts-revised
  stage: test
  image: $SALSA_CI_IMAGES_PIUPARTS
  rules:
    - if: $SALSA_CI_ENABLE_PIUPARTS =~ /^(1|yes|true)$/
    - if: $SALSA_CI_DISABLE_ALL_TESTS =~ /^(1|yes|true)$/
      when: never
    - if: $SALSA_CI_DISABLE_PIUPARTS !~ /^(1|yes|true)$/
  services:
    - docker:20.10.12-dind
  script:
    - CHROOT_PATH="/tmp/debian-chroot"
    - CONTAINER_ID=$(docker run --rm -d "${SALSA_CI_IMAGES_BASE}" sleep infinity)
    - docker exec ${CONTAINER_ID} bash -c "apt-get update && apt-get upgrade -y"
    - docker exec ${CONTAINER_ID} bash -c "apt-get install eatmydata -y"
    - mkdir -p ${CHROOT_PATH}
    - docker export ${CONTAINER_ID} | tar -C ${CHROOT_PATH} -xf -
    - mknod -m 666 ${CHROOT_PATH}/dev/urandom c 1 9
    - mkdir -p /srv/local-apt-repository/ && cp -a ${WORKING_DIR}/*.deb /srv/local-apt-repository/ && /usr/lib/local-apt-repository/rebuild
    - mkdir -p ${CHROOT_PATH}/etc-target/apt/sources.list.d ${CHROOT_PATH}/etc-target/apt/preferences.d
    - cp -Hv /etc/apt/sources.list.d/local-apt-repository.list ${CHROOT_PATH}/etc-target/apt/sources.list.d/
    - cp -aTLv /etc/apt/preferences.d  ${CHROOT_PATH}/etc-target/apt/preferences.d
    - cp -aTLv /srv/local-apt-repository ${CHROOT_PATH}/srv/local-apt-repository
    - cp -aTLv /var/lib/local-apt-repository/ ${CHROOT_PATH}/var/lib/local-apt-repository/
    - test -n "${SALSA_CI_PIUPARTS_PRE_INSTALL_SCRIPT}" && cp -aTLv "${SALSA_CI_PIUPARTS_PRE_INSTALL_SCRIPT}" /etc/piuparts/scripts/pre_install_salsa_ci && chmod 755 /etc/piuparts/scripts/pre_install_salsa_ci
    - test -n "${SALSA_CI_PIUPARTS_POST_INSTALL_SCRIPT}" && cp -aTLv "${SALSA_CI_PIUPARTS_POST_INSTALL_SCRIPT}" /etc/piuparts/scripts/post_install_salsa_ci && chmod 755 /etc/piuparts/scripts/post_install_salsa_ci
    - add_extra_repository.sh -v -e "${SALSA_CI_EXTRA_REPOSITORY}"
      -k "${SALSA_CI_EXTRA_REPOSITORY_KEY}" -t "${CHROOT_PATH}/etc-target"
    - *add-dependencies
    - mv new-packages-testing.list ${PIUPARTS_APT_PATH}/sources.list.d/new-packages-testing.list
    - [ ! -e ${PIUPARTS_GPG_TRUSTED_DIR} ] && mkdir -p ${PIUPARTS_GPG_TRUSTED_DIR}
    - mv *.asc ${PIUPARTS_GPG_TRUSTED_DIR}
    - sed  '/127.0.0.1/s/localhost/pipeline.salsa.debian.org localhost/' /etc/hosts > ${CHROOT_PATH}/etc/hosts
    - PIUPARTS_DISTRIBUTION_ARG="--distribution $RELEASE"
    - |
      if [ "$VENDOR" = "debian" ]; then \
        CODENAME=$(wget -O - ${SALSA_CI_MIRROR}/dists/${RELEASE}/Release | awk "/^Codename:/ { print \$2 }" | sed -e "s/-backports//"); \
        PIUPARTS_DISTRIBUTION_ARG="--distribution ${CODENAME}"; \
      fi
    - |
      (for PACKAGE in $(ls ${WORKING_DIR}/*.deb); do
        piuparts --mirror "${SALSA_CI_MIRROR} ${SALSA_CI_COMPONENTS}" ${SALSA_CI_PIUPARTS_ARGS} --scriptsdir /etc/piuparts/scripts --allow-database --warn-on-leftovers-after-purge --hard-link -e ${CHROOT_PATH} ${PIUPARTS_DISTRIBUTION_ARG} ${PACKAGE}
      done) | filter-output
  variables:
    # To make the repository available in this job,
    # so SALSA_CI_PIUPARTS_{PRE,POST}_INSTALL_SCRIPT
    # can refer to committed scripts
    GIT_STRATEGY: fetch
  needs:
    - job: build
      artifacts: true

# Override pipeline-jobs.yml with new definitions.

autopkgtest:
  extends: .test-autopkgtest-revised

piuparts:
  extends: .test-piuparts-revised
